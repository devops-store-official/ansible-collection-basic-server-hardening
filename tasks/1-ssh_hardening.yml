---
# SSH Hardening tasks

- name: "Ensure SSH is installed"
  ansible.builtin.package:
    name: openssh-server
    state: present
  tags: ['ssh']

- name: "Backup original SSH config"
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.backup
    remote_src: true
    force: false
  tags: ['ssh']

- name: "Deploy hardened SSH configuration"
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: '0644'
    validate: '/usr/sbin/sshd -t -f %s'
    backup: true
  notify: restart ssh
  tags: ['ssh']

- name: "Ensure SSH service is enabled and started"
  ansible.builtin.systemd:
    name: "{{ 'ssh' if ansible_facts.os_family == 'Debian' else 'sshd' }}"
    enabled: true
    state: started
  tags: ['ssh']
