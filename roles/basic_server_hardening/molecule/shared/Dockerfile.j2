# molecule/shared/Dockerfile.j2
# Dockerfile for Molecule testing (Debian 12/13, Ubuntu 22.04/24.04)
FROM {{ item.image }}

ENV container=docker

# Clean systemd
RUN rm -f /lib/systemd/system/multi-user.target.wants/* \
    && rm -f /etc/systemd/system/*.wants/* \
    && rm -f /lib/systemd/system/local-fs.target.wants/* \
    && rm -f /lib/systemd/system/sockets.target.wants/*udev* \
    && rm -f /lib/systemd/system/sockets.target.wants/*initctl* \
    && rm -f /lib/systemd/system/basic.target.wants/* \
    && rm -f /lib/systemd/system/anaconda.target.wants/*

# Install prerequisites
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        systemd systemd-sysv python3 python3-apt sudo bash \
        ca-certificates curl gnupg lsb-release rsync cron iproute2 \
        openssh-server locales iptables \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Configure ansible user
RUN useradd -m -s /bin/bash ansible && \
    echo "ansible ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ansible && \
    chmod 0440 /etc/sudoers.d/ansible

# Setup SSH
RUN mkdir -p /home/ansible/.ssh && \
    chmod 0700 /home/ansible/.ssh && \
    chown ansible:ansible /home/ansible/.ssh && \
    ssh-keygen -A

# Enable SSH service
RUN systemctl enable ssh || systemctl enable sshd

CMD ["/lib/systemd/systemd"]
